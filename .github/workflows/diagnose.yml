name: Repository Diagnostics

on:
  workflow_dispatch:
    inputs:
      diagnostic_level:
        description: 'Diagnostic level (basic, full, deep)'
        required: false
        default: 'basic'
        type: choice
        options:
        - basic
        - full
        - deep
  push:
    branches: [ main, develop ]
    paths: 
      - '.github/workflows/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'vite.config.ts'
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  system-diagnostics:
    name: System Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: System Information
        run: |
          echo "ğŸ” SYSTEM DIAGNOSTICS REPORT"
          echo "============================="
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ–¥ï¸  OS: $(uname -a)"
          echo "ğŸ“¦ Node.js: $(node --version)"
          echo "ğŸ“¦ npm: $(npm --version)"
          echo "ğŸ”„ Git commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo

      - name: Repository Structure Analysis
        run: |
          echo "ğŸ“ REPOSITORY STRUCTURE"
          echo "======================="
          echo "ğŸ“Š Total files: $(find . -type f | wc -l)"
          echo "ğŸ“Š Directory count: $(find . -type d | wc -l)"
          echo "ğŸ“Š Code files: $(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | wc -l)"
          echo "ğŸ“Š Test files: $(find . -name "*.test.*" -o -name "*.spec.*" | wc -l)"
          echo "ğŸ“Š Config files: $(find . -name "*.config.*" -o -name "*.json" | wc -l)"
          echo
          echo "ğŸ“‚ Directory structure:"
          tree -L 3 -I node_modules || ls -la
          echo

      - name: Package Dependencies Analysis
        run: |
          echo "ğŸ“¦ DEPENDENCY ANALYSIS"
          echo "====================="
          
          if [ -f package.json ]; then
            echo "âœ… package.json found"
            echo "ğŸ“Š Dependencies: $(jq '.dependencies | length' package.json)"
            echo "ğŸ“Š DevDependencies: $(jq '.devDependencies | length' package.json)"
            echo "ğŸ“Š Scripts: $(jq '.scripts | length' package.json)"
            echo
            echo "ğŸ”§ Available scripts:"
            jq -r '.scripts | keys[]' package.json | sed 's/^/  - /'
            echo
          else
            echo "âŒ package.json not found"
          fi

          if [ -f package-lock.json ]; then
            echo "âœ… package-lock.json found"
            echo "ğŸ“Š Locked packages: $(jq '.packages | length' package-lock.json)"
          else
            echo "âš ï¸  package-lock.json not found"
          fi

      - name: Install dependencies (if needed)
        run: |
          echo "ğŸ“¥ DEPENDENCY INSTALLATION"
          echo "=========================="
          
          if [ -f package.json ]; then
            echo "ğŸ”„ Installing dependencies..."
            npm ci --prefer-offline --no-audit --progress=false
            echo "âœ… Dependencies installed successfully"
          else
            echo "âŒ Cannot install dependencies - package.json missing"
            exit 1
          fi

      - name: Configuration Files Check
        run: |
          echo "âš™ï¸  CONFIGURATION ANALYSIS"
          echo "========================="
          
          configs=("tsconfig.json" "vite.config.ts" "tailwind.config.ts" "eslint.config.js" "vitest.config.ts" ".env.example" "docker-compose.yml" "Dockerfile" "nginx.conf")
          
          for config in "${configs[@]}"; do
            if [ -f "$config" ]; then
              echo "âœ… $config"
            else
              echo "âŒ $config (missing)"
            fi
          done
          echo

      - name: Code Quality Diagnostics
        run: |
          echo "ğŸ” CODE QUALITY DIAGNOSTICS"
          echo "==========================="
          
          echo "ğŸ“ Running linter..."
          if npm run lint 2>&1; then
            echo "âœ… Linting passed"
          else
            echo "âŒ Linting issues found"
          fi
          echo
          
          echo "ğŸ” Running type check..."
          if npx tsc --noEmit 2>&1; then
            echo "âœ… Type checking passed"
          else
            echo "âŒ Type errors found"
          fi
          echo

      - name: Test Environment Diagnostics
        run: |
          echo "ğŸ§ª TEST ENVIRONMENT DIAGNOSTICS"
          echo "==============================="
          
          echo "ğŸ” Checking test configuration..."
          if [ -f "vitest.config.ts" ]; then
            echo "âœ… Vitest config found"
          else
            echo "âŒ Vitest config missing"
          fi
          
          if [ -d "src/test" ]; then
            echo "âœ… Test directory found"
            echo "ğŸ“Š Test setup files: $(find src/test -name "*.ts" | wc -l)"
          else
            echo "âš ï¸  No test directory found"
          fi
          
          echo "ğŸ“Š Test files: $(find . -name "*.test.*" -o -name "*.spec.*" | wc -l)"
          echo
          
          echo "ğŸƒ Running tests..."
          if npm run test:run 2>&1; then
            echo "âœ… Tests passed"
          else
            echo "âŒ Test failures detected"
          fi

      - name: Security Diagnostics
        run: |
          echo "ğŸ”’ SECURITY DIAGNOSTICS"
          echo "======================="
          
          echo "ğŸ” Running security audit..."
          npm audit --audit-level=moderate || echo "âš ï¸  Security vulnerabilities found"
          echo
          
          echo "ğŸ” Checking for sensitive files..."
          sensitive_files=(".env" "*.key" "*.pem" "config/secrets.json")
          found_sensitive=false
          
          for pattern in "${sensitive_files[@]}"; do
            if find . -name "$pattern" -not -path "./node_modules/*" | grep -q .; then
              echo "âš ï¸  Found sensitive file pattern: $pattern"
              found_sensitive=true
            fi
          done
          
          if [ "$found_sensitive" = false ]; then
            echo "âœ… No sensitive files found in repository"
          fi

      - name: Database Diagnostics
        run: |
          echo "ğŸ—„ï¸  DATABASE DIAGNOSTICS"
          echo "======================="
          
          if [ -f "prisma/schema.prisma" ]; then
            echo "âœ… Prisma schema found"
            echo "ğŸ“Š Models count: $(grep -c "^model " prisma/schema.prisma || echo "0")"
            echo "ğŸ“Š Migrations: $(find prisma/migrations -name "*.sql" 2>/dev/null | wc -l || echo "0")"
            
            echo "ğŸ” Checking Prisma client..."
            if npx prisma generate 2>&1; then
              echo "âœ… Prisma client generation successful"
            else
              echo "âŒ Prisma client generation failed"
            fi
          else
            echo "âš ï¸  No Prisma schema found"
          fi

      - name: Build System Diagnostics  
        run: |
          echo "ğŸ—ï¸  BUILD SYSTEM DIAGNOSTICS"
          echo "==========================="
          
          echo "ğŸ” Testing build process..."
          if npm run build 2>&1; then
            echo "âœ… Build successful"
            
            if [ -d "dist" ]; then
              echo "ğŸ“Š Build output size: $(du -sh dist | cut -f1)"
              echo "ğŸ“Š Build files: $(find dist -type f | wc -l)"
            fi
          else
            echo "âŒ Build failed"
          fi

      - name: Docker Diagnostics
        if: github.event.inputs.diagnostic_level == 'full' || github.event.inputs.diagnostic_level == 'deep'
        run: |
          echo "ğŸ³ DOCKER DIAGNOSTICS"
          echo "====================="
          
          if [ -f "Dockerfile" ]; then
            echo "âœ… Dockerfile found"
            echo "ğŸ” Dockerfile validation..."
            
            # Basic Dockerfile validation
            if grep -q "FROM" Dockerfile; then
              echo "âœ… Base image specified"
            else
              echo "âŒ No base image found"
            fi
            
            if grep -q "WORKDIR" Dockerfile; then
              echo "âœ… Working directory set"
            else
              echo "âš ï¸  No working directory specified"
            fi
            
            if grep -q "EXPOSE" Dockerfile; then
              echo "âœ… Port exposed"
            else
              echo "âš ï¸  No port exposed"
            fi
          else
            echo "âš ï¸  No Dockerfile found"
          fi
          
          if [ -f "docker-compose.yml" ]; then
            echo "âœ… Docker Compose configuration found"
          else
            echo "âš ï¸  No Docker Compose configuration"
          fi

      - name: Performance Diagnostics
        if: github.event.inputs.diagnostic_level == 'deep'
        run: |
          echo "âš¡ PERFORMANCE DIAGNOSTICS"
          echo "========================="
          
          echo "ğŸ“Š Bundle size analysis..."
          if [ -d "dist" ]; then
            echo "ğŸ” Analyzing build output..."
            find dist -name "*.js" -exec wc -c {} + | sort -n
            echo
            echo "ğŸ“Š Largest files:"
            find dist -type f -exec du -h {} + | sort -rh | head -10
          else
            echo "âš ï¸  No build output found for analysis"
          fi

      - name: Generate Diagnostic Report
        run: |
          echo "ğŸ“‹ DIAGNOSTIC SUMMARY"
          echo "===================="
          echo "âœ… System diagnostics completed"
          echo "ğŸ“… Report generated: $(date)"
          echo "ğŸ”„ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo
          echo "ğŸ” Check individual steps above for detailed analysis"
          echo "ğŸ’¡ To run full diagnostics: workflow_dispatch with 'full' or 'deep' level"

      - name: Upload Diagnostic Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: diagnostic-report-${{ github.sha }}
          path: |
            package.json
            package-lock.json
            tsconfig.json
            vite.config.ts
            vitest.config.ts
            .github/workflows/
          retention-days: 7

  dependency-vulnerabilities:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    if: github.event.inputs.diagnostic_level == 'full' || github.event.inputs.diagnostic_level == 'deep'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run comprehensive security audit
        run: |
          echo "ğŸ”’ COMPREHENSIVE SECURITY AUDIT"
          echo "==============================="
          
          echo "ğŸ“‹ Full audit report:"
          npm audit --json > audit.json || true
          
          echo "ğŸ” High/Critical vulnerabilities:"
          npm audit --audit-level=high --json | jq '.vulnerabilities' || echo "No high/critical issues"
          
          echo "ğŸ“Š Audit summary:"
          npm audit || echo "Issues found - check details above"

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-${{ github.sha }}
          path: audit.json
          retention-days: 14